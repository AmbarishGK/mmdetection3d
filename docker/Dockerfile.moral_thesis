# =========================================================
# MoRAL Docker Image - Complete Setup Guide
# =========================================================
# Image: ambarishgk007/moral-bevfusion-thesis:v1.0
# Purpose: BEVFusion inference + LLM reasoning for MoRAL thesis
# CUDA: 11.8 | PyTorch: 2.1.2 | MMDetection3D: 1.4.0
# =========================================================

# =========================================================
# STEP 1: COMMIT YOUR CURRENT CONTAINER
# Run these on your LOCAL machine (not inside Docker)
# =========================================================

# Find your container name
# docker ps -a

# Commit container with checkpoints included
# docker commit moral_container ambarishgk007/moral-bevfusion-thesis:v1.0

# Push to Docker Hub
# docker login
# docker push ambarishgk007/moral-bevfusion-thesis:v1.0
# docker tag ambarishgk007/moral-bevfusion-thesis:v1.0 ambarishgk007/moral-bevfusion-thesis:latest
# docker push ambarishgk007/moral-bevfusion-thesis:latest

# =========================================================
# ALTERNATIVELY: Build from this Dockerfile
# =========================================================

FROM ambarishgk007/mmdetect-11.8-bevfusion-compiled:latest

# Set working directory
WORKDIR /workspace/mmdetection3d

# Download BEVFusion checkpoint
RUN mkdir -p checkpoints/bevfusion && \
    wget -q https://download.openmmlab.com/mmdetection3d/v1.1.0_models/bevfusion/bevfusion_lidar-cam_voxel0075_second_secfpn_8xb4-cyclic-20e_nus-3d-5239b1af.pth \
    -O checkpoints/bevfusion/bevfusion_lidar-cam_voxel0075_second_secfpn_8xb4-cyclic-20e_nus-3d-5239b1af.pth

# Pre-download Swin Transformer backbone
RUN python -c "import torch; torch.hub.load_state_dict_from_url('https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth', map_location='cpu')"

# Install additional packages for MoRAL
RUN pip install openai anthropic matplotlib pillow

# Create MoRAL workspace
RUN mkdir -p /workspace/moral/{scripts,results,notebooks}

# Copy MoRAL scripts
COPY moral_bev_extractor.py /workspace/moral/scripts/
COPY moral_visualizer.py /workspace/moral/scripts/
COPY moral_llm_integration.py /workspace/moral/scripts/

# Set environment
ENV PYTHONPATH="/workspace/mmdetection3d:${PYTHONPATH}"

# Default command
CMD ["/bin/bash"]
